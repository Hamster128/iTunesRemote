<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content = "user-scalable=no"/>
    <meta http-equiv="Pragma" content="no-cache">
    <link rel="apple-touch-icon" href="img/icon.png"/>
    <link rel="apple-touch-startup-image" href="img/startup.png">
    <link rel="apple-touch-startup-image" href="img/startup.png"   media="(device-width: 320px) and (device-height: 480px) and (-webkit-device-pixel-ratio: 1)">
    <link rel="apple-touch-startup-image" href="img/startupR.png"  media="(device-width: 320px) and (device-height: 480px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="img/startup5R.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="stylesheet" type="text/css" href="css/my.css">
    <title>Remote Pro</title>
  </head>
  <body class="darkBackground" style="margin:0; position:fixed; overflow:hidden; font-family:Arial;" onMouseUp="endVolume(false); endPosition(false);" onTouchEnd="endVolume(true); endPosition(true);">
    <script src="js/socket.io_4.7.1.min.js"></script>
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/itunes_api.js"></script>
    
    <div id="divMain" class="vertOnly" style="width:100vw; height:100vh; position:absolute; background:#EEE;">
      <!-- play lists page -->
      <div id="tabPlaylists" style="position:absolute; left:0px; top:0px; width:100vw; bottom:200px;">
      
        <div style="position:absolute; left:0px; top:0px; right:0px; height:150px;">
          <table style="width:100%; height:150px; border-bottom:4px solid #555;" cellspacing=0><tr>
            <td style="width:200px;" onTouchStart="onPlaylistsBack(true)" onClick="onPlaylistsBack()"><img id="imgPlaylistsBack" style="visibility:hidden;" src="img/back.png"></td>
            <td style="text-align:center; font-size:60px; font-weight:bold;" id="tdPlaylistsTitle">Playlists</td>
            <td class="tdNow" style="width:200px; text-align:center; font-size:60px; color:#66F;" onTouchStart="onNow(true)" onClick="onNow()">Now</td>
          </tr></table>
        </div>
      
        <div id="divPlaylists" class="scrollable" style="position:absolute; left:0px; top:150px; width:100vw; bottom:0px; overflow:scroll; -webkit-overflow-scrolling:touch;">
          <table id="tablePlaylists" cellspacing=0 style="width:100%;">
          </table>
        </div>
        
        <div id="divPlaylist" class="scrollable" style="position:absolute; left:100vw; top:150px; width:100vw; bottom:0px; overflow:scroll; -webkit-overflow-scrolling:touch;">
          <table id="tablePlaylist" cellspacing=0 style="width:100%;">
          </table>
        </div>
        
        <div id="divPlaylistAlbum" class="scrollable" style="position:absolute; left:100vw; top:150px; width:100vw; bottom:0px; overflow:scroll; -webkit-overflow-scrolling:touch;">
          <table id="tablePlaylistAlbum" cellspacing=0 style="width:100%;">
          </table>
        </div>
      </div>
    
      <!-- artist page -->
      <div id="tabArtists" style="position:absolute; left:0px; top:0px; width:100vw; bottom:200px; display:none;">
      
        <div style="position:absolute; left:0px; top:0px; right:0px; height:150px;">
          <table style="width:100%; height:150px; border-bottom:4px solid #555;" cellspacing=0><tr>
            <td style="width:200px;" onTouchStart="onArtistsBack(true)" onClick="onArtistsBack()"><img id="imgArtistsBack" style="visibility:hidden;" src="img/back.png"></td>
            <td style="text-align:center; font-size:60px; font-weight:bold;" id="tdArtistsTitle">Artists</td>
            <td class="tdNow"  style="width:200px; text-align:center; font-size:60px; color:#66F;" onTouchStart="onNow(true)" onClick="onNow()">Now</td>
          </tr></table>
        </div>
      
        <div id="divArtists" style="position:absolute; left:0px; top:150px; width:100vw; bottom:0px;">
          <div style="position:absolute; left:0px; right:0px; top:0px; height:110px;">
            <input type="text" id="inputSearchArtists" class="inputSearch" onKeyUp="onKeySearchArtist(event)"></input>
          </div>
          <div  class="scrollable" style="position:absolute; left:0px; top:112px; width:100vw; bottom:0px; overflow:scroll; -webkit-overflow-scrolling:touch;">
             <table id="tableArtists" cellspacing=0 style="width:100%;">             
             </table>            
          </div>
        </div>
        
        <div id="divArtistAlbums" class="scrollable" style="position:absolute; left:100vw; top:150px; width:100vw; bottom:0px; overflow:scroll; -webkit-overflow-scrolling:touch;">
          <table id="tableArtistAlbums" cellspacing=0 style="width:100%;">
          </table>
        </div>
        
        <div id="divArtistAlbum" class="scrollable" style="position:absolute; left:100vw; top:150px; width:100vw; bottom:0px; overflow:scroll; -webkit-overflow-scrolling:touch;">
          <table id="tableArtistAlbum" cellspacing=0 style="width:100%;">
          </table>
        </div>
      </div>
      
      <!-- songs page -->
      <div id="tabSongs" style="position:absolute; left:0px; top:0px; width:100vw; bottom:200px; display:none;">
      
        <div style="position:absolute; left:0px; top:0px; right:0px; height:150px;">
          <table style="width:100%; height:150px; border-bottom:4px solid #555;" cellspacing=0><tr>
            <td style="width:200px;"></td>
            <td style="text-align:center; font-size:60px; font-weight:bold;" id="tdSongTitle">Songs</td>
            <td class="tdNow"  style="width:200px; text-align:center; font-size:60px; color:#66F;" onTouchStart="onNow(true)" onClick="onNow()">Now</td>
          </tr></table>
        </div>
      
        <div id="divSongs" style="position:absolute; left:0px; top:150px; width:100vw; bottom:0px;">
          <div style="position:absolute; left:0px; right:0px; top:0px; height:110px;">
            <input type="text" id="inputSearchSongs" class="inputSearch" onKeyUp="onKeySearchSong(event)"></input>
          </div>
          <div  class="scrollable" style="position:absolute; left:0px; top:112px; width:100vw; bottom:0px; overflow:scroll; -webkit-overflow-scrolling:touch;">
             <table id="tableSongs" cellspacing=0 style="width:100%;">             
             </table>            
          </div>
        </div>
      </div>

      <!-- albums page -->
      <div id="tabAlbums" style="position:absolute; left:0px; top:0px; width:100vw; bottom:200px; display:none;">
      
        <div style="position:absolute; left:0px; top:0px; right:0px; height:150px;">
          <table style="width:100%; height:150px; border-bottom:4px solid #555;" cellspacing=0><tr>
            <td style="width:200px;" onTouchStart="onAlbumsBack(true)" onClick="onAlbumsBack()"><img id="imgAlbumsBack" style="visibility:hidden;" src="img/back.png"></td>
            <td style="text-align:center; font-size:60px; font-weight:bold;" id="tdAlbumsTitle">Albums</td>
            <td class="tdNow"  style="width:200px; text-align:center; font-size:60px; color:#66F;" onTouchStart="onNow(true)" onClick="onNow()">Now</td>
          </tr></table>
        </div>
      
        <div id="divAlbums" style="position:absolute; left:0px; top:150px; width:100vw; bottom:0px;">
          <div style="position:absolute; left:0px; right:0px; top:0px; height:110px;">
            <input type="text" id="inputSearchAlbums" class="inputSearch" onKeyUp="onKeySearchAlbum(event)"></input>
          </div>
          <div  class="scrollable" style="position:absolute; left:0px; top:112px; width:100vw; bottom:0px; overflow:scroll; -webkit-overflow-scrolling:touch;">
             <table id="tableAlbums" cellspacing=0 style="width:100%;">             
             </table>            
          </div>
        </div>

        <div id="divSearchedAlbum" class="scrollable" style="position:absolute; left:100vw; top:150px; width:100vw; bottom:0px; overflow:scroll; -webkit-overflow-scrolling:touch;">
          <table id="tableSearchedAlbum" cellspacing=0 style="width:100%;">
          </table>
        </div>
      </div>

      <!-- main menu -->
      <div style="position:absolute; left:0px; right:0px; bottom:0px; height:200px; background:#EEE;">
        <table cellspacing=0 style="width:100%; height:150px; border-top:4px solid #555;"><tr>
          <td style="text-align:center;" onTouchStart="onMainPlaylists(event, true)" onClick="onMainPlaylists(event)"><img id="imgMainPlaylists" src="img/playlist_active.png"></td>
          <td style="text-align:center;" onTouchStart="onMainArtists(event, true)" onClick="onMainArtists(event)"><img id="imgMainArtists" src="img/interpret.png"></td>
          <td style="text-align:center;" onTouchStart="onMainSongs(event, true)" onClick="onMainSongs(event)"><img id="imgMainSongs" src="img/song.png"></td>
          <td style="text-align:center;" onTouchStart="onMainAlbums(event, true)" onClick="onMainAlbums(event)"><img id="imgMainAlbums" src="img/album.png"></td>
        </tr></table>
      </div>
    </div>

    <!-- player page -->
    <div id="divPlayer" class="divPlayerPage pageWidth prevent-select" style="height:100vh; position:absolute;">
      <div id="divVolumeDigitsOverlay" class="pageWidth" style="display:none; z-index:2; height:100%; position:absolute; font-size:170px; background:rgba(0,0,0,.7); color:#FFF; text-align:center; padding-top:500px;">
       24.0 dB
      </div>
    
      <div class="artworkWidth" style="height:100%; position:absolute; overflow:hidden; text-align:center;">
        <img id="artwork1" class="imgArtwork "style="position:relative;">
      </div>
      <div class="artworkWidth" style="height:100%; position:absolute; overflow:hidden; text-align:center;">
        <img id="artwork2" class="imgArtwork "style="position:relative; display:none;">
      </div>
      <div class="artworkWidth" style="height:100%; position:absolute; overflow:hidden; text-align:center;">
        <img id="artwork3" class="imgArtwork "style="position:relative; display:none;">
      </div>
      <div class="artworkWidth" style="height:100%; position:absolute; overflow:hidden; text-align:center;">
        <img id="artwork4" class="imgArtwork "style="position:relative; display:none;">
      </div>
      <div class="artworkWidth" style="height:100%; position:absolute; overflow:hidden; text-align:center;">
        <img id="artwork5" class="imgArtwork "style="position:relative; display:none;">
      </div>
      <div class="artworkWidth" style="height:100%; position:absolute; overflow:hidden; text-align:center;">
        <img id="artwork6" class="imgArtwork "style="position:relative; display:none;">
      </div>
      <div class="artworkWidth" style="height:100%; position:absolute; overflow:hidden; text-align:center;">
        <img id="artwork7" class="imgArtwork "style="position:relative; display:none;">
      </div>
      <div class="artworkWidth" style="height:100%; position:absolute; overflow:hidden; text-align:center;">
        <img id="artwork8" class="imgArtwork "style="position:relative; display:none;">
      </div>
      <div class="artworkWidth" style="height:100%; position:absolute; overflow:hidden; text-align:center;">
        <img id="artwork9" class="imgArtwork "style="position:relative; display:none;">
      </div>
      <div class="artworkWidth" style="height:100%; position:absolute; overflow:hidden; text-align:center;">
        <img id="artwork10" class="imgArtwork "style="position:relative; display:none;">
      </div>
      
      <div class="pageWidth" style="position:absolute; z-index:1; height:100%;">
        <table class="pageWidth" style="height:100%;" cellspacing=0 cellpadding=0>
          <tr class="dark_background" style="height:130px;"><td>
            <table style="width:100%">
              <tr>
                <td class="vertOnly" style="vertical-align:top; padding-top:30px;" onTouchStart="playerBack(event, true)" onClick="playerBack(event)"><img src="img/back_w.png"></td>
                <td style="text-align:center; color:#FFF;" onTouchStart="playerBack(event, true)" onClick="playerBack(event)">
                  <span id='track' class="track_title" style="font-weight:bold;"></span><br>
                  <span id='album_artist' class="artist_album_title"></span>
                </td>
                <td class="vertOnly" onTouchStart="onDSP(true)" onClick="onDSP()"><img id="imgDSP" src="img/dsp_off.png" ></td>
            </table>
          </td></tr>
          
          <!-- track info oerlay -->
          <tr><td style="">
            <div id="divTrackInfo" class="vertOnly" style="width:100%; height:100%; background:rgba(0,0,0,.7); color:#FFF; opacity:0;" onTouchStart="onTrackInfo(event, true)" onClick="onTrackInfo(event)">
              <table style="width:80%; margin:0 auto; font-size:50px;">
                <tr style="height:80px;"><td></td></tr>
                <tr><td id="trackRating" style="text-align:center; font-size:120px;"></td></tr>
                <tr><td id="trackQuality"></td></tr>
                <tr><td id="trackBitRate"></td></tr>
                <tr><td id="trackSampleRate"></td></tr>
                <tr><td>Played Count: <span id="trackPlayedCount"></span></td></tr>
                <tr><td id="trackComposer"></td></tr>
                <tr><td id="trackComment"></td></tr>
              </table>
            </div>
          </td></tr>
          
          <!-- player position -->
          <tr class="dark_background trPlayerPosition"><td style="text-align:center;">
            <table id="tablePosition" style="width:100%; height:100%;">
              <tr>
                <td class="player_position_time player_pos_left" style="text-align:right; color:#FFF; font-family:Arial; padding-right:20px;" id="tdAt">0</td>
                <td style="text-align:center;" onMouseDown="onPosition(false, event)" onTouchStart="onPosition(true, event)" onMouseMove="onPositionMove(false, event)" onTouchMove="onPositionMove(true, event)" id="tdBar">
                  <div class="progressBar" style="width:100%; border:3px solid #FFF;"><div id="divTime" style="background:#FFF; width:0; height:100%"></div></div>
                </td>
                <td class="player_position_time player_pos_right" style="text-align:left; color:#FFF; font-family:Arial; padding-left:20px;" id="tdLeft">0</td>
              </tr>
            </table>
          </td></tr>
          
          <!-- player main controls -->
          <tr class="vertOnly" style="height:200px; background-color:rgba(0,0,0,.5);"><td>
            <table style="width:100%; height:100%">
              <tr>
                <td style="text-align:center;" id="tdPrev" onTouchStart="onPrev(true)" onMouseDown="onPrev()" onTouchEnd="endPrev(true)" onMouseUp="endPrev()"><img src="img/prev.png" style="cursor:pointer;"></td>
                <td style="text-align:center;" id="tdPlay" onTouchStart="onPlay(true)" onMouseDown="onPlay()" onTouchEnd="endPlay(true)" onMouseUp="endPlay()"><img id="btnPlay" src="img/play.png" style="cursor:pointer;"></td>
                <td style="text-align:center;" id="tdNext" onTouchStart="onNext(true)" onMouseDown="onNext()" onTouchEnd="endNext(true)" onMouseUp="endNext()"><img src="img/next.png" style="cursor:pointer;"></td>
              </tr>
            </table>
          </td></tr>
          
          <!-- player volume -->
          <tr class="vertOnly" style="height:100px; background-color:rgba(0,0,0,.5);"><td>
            <table style="width:100%; height:100%;">
              <tr>
                <td style="width:5%;"></td>
                <td style="text-align:center;" onMouseDown="onVolume(false, event)" onTouchStart="onVolume(true, event)" onMouseMove="onVolumeMove(false, event)" onTouchMove="onVolumeMove(true, event)" id="tdVolume">
                  <table cellspacing=0 cellpadding=0 style="width:100%"><tr>
                    <td style="width:1px;"><div id='divVolumeDigits' style='padding-right:20px; width:100px; color:#FFF; display:none; font-family:Arial; font-size:40px;'>12</div></td>
                    <td><div style="width:100%; height:30px; border-radius:15px; border:3px solid #FFF; display:inline-block;" id="divVolumeSlider">
                      <div id="divVolume" style="background:#FFF; border-radius:10px; width:0; height:100%"></div>
                    </div></td>
                  </tr></table>
                </td>
                <td style="width:5%;"></td>
              </tr>
            </table>
          </td></tr>
          
          <!-- player menu -->
          <tr class="vertOnly" style="height:150px; background-color:rgba(0,0,0,.5);"><td>
            <table style="width:100%"><tr>
              <td id="tdAlbum" style="text-align:center;" onTouchStart="onAlbum(event, true)" onClick="onAlbum(event)"><img src="img/album.png"></td>
              <td style="text-align:center;" onTouchStart="onRepeat(true)" onClick="onRepeat()" id="tdRepeat"><img src="img/repeat.png" id="imgRepeat"></td>
              <td style="text-align:center;"><img src="img/queue.png"></td>
              <td style="text-align:center;" onTouchStart="onShuffle(true)" onClick="onShuffle()" id="tdShuffle"><img src="img/shuffle.png"></td>
              <td style="text-align:center;" onTouchStart="onTracksPlaylists(event, true)" onClick="onTracksPlaylists(event)"><img src="img/list.png"></td>
            </tr></table>
          </td></tr>
          <tr class="vertOnly" style="height:40px;"><td></td></tr>
        </table>
      </div>
    </div>    
    
    <div id="divAlbum" class="vertOnly" style="position:absolute; top:100vh; width:100vw; height:100vh; z-index:1; background:#EEE;">
      <div style="position:absolute; left:0px; top:0px; right:0px; height:490px;">
        <table style="width:100%; height:150px; border-bottom:4px solid #555;" cellspacing=0><tr>
          <td style="width:200px; text-align:center;"></td>
          <td style="text-align:center; font-size:60px; font-weight:bold;">Album</td>
          <td style="width:200px; text-align:center; font-size:60px; color:#66F;" onTouchStart="albumBack(event, true)" onClick="albumBack(event)">Back</td>
        </tr></table>
        <table style="width:100%; height:322px;" cellspacing=0 cellpadding=0>
          <tr><td>
          </td></tr>
          <tr onClick="onCurrentAlbum()"><td style="padding:20px; background:#FFF;">
            <table style="width:100%;"><tr>
              <td style="width:300px;">
                <img id="artwork_album" src="img/current1.png" style="width:100%">
              </td>
              <td style="vertical-align:top; font-size:40px; padding-left:20px;">
                <span id="albumName" style="font-size:40px; font-weight:bold;"></span><br>
                Artist:&nbsp;<span id="albumArtist" ></span><br>
                Year:&nbsp;<span id="albumYear"></span>
              </td>
            </tr></table>
          </td></tr>
        </table>
      </div>
      <div id="divAlbumTracklist" class="scrollable" style="position:absolute; left:0px; top:490px; right:0px; bottom:0px; overflow:scroll; -webkit-overflow-scrolling:touch;">
        <table id="tableAlbumTracks" cellspacing=0 style="width:100%; padding-bottom:60px;">
        </table>
      </div>
    </div>

    <div id="divTracksPlaylists" class="vertOnly" style="position:absolute; top:100vh; width:100vw; height:100vh; z-index:1; background:#EEE;">
      <div style="position:absolute; left:0px; top:0px; right:0px; height:150px;">
        <table style="width:100%; height:150px; border-bottom:4px solid #555;" cellspacing=0><tr>
          <td style="width:200px;"></td>
          <td style="text-align:center; font-size:60px; font-weight:bold;">Playlists</td>
          <td style="width:200px; text-align:center; font-size:60px; color:#66F;" onTouchStart="tracksPlaylistsBack(event, true)" onClick="tracksPlaylists(event)">Back</td>
        </tr></table>
      </div>
      <div id="divTracksPlaylistsList" class="scrollable" style="position:absolute; left:0px; top:150px; right:0px; bottom:0px; overflow:scroll; -webkit-overflow-scrolling:touch;">
        <table id="tableTracksPlaylists" cellspacing=0 style="width:100%; padding-bottom:60px;">
        </table>
      </div>
    </div>

    <!-- message -->
    <div id="divMessage" class="vertOnly message">
      <span id="spanMessage">Track queued</span>
    </div>

    <!-- no track page -->
    <div id="divNoTrack" class="landscapeOnly darkBackground" style="z-index:3; height:100vh; width:100vw; position:absolute;">
      <div style="height:100vh; width:100vw; position:absolute;">
      </div>
      <div style="height:100vh; width:100vw; position:absolute; color:#FFF;">
        <img src="img/itunes.png" style="position:absolute; top:0; bottom:0; left:0; right:0; margin:auto;">
      </div>
    </div>

    <!-- audio mute page -->
    <div id="divAudioDeviceMute" class="darkBackground" style="z-index:4; display:none; height:100vh; width:100vw; position:absolute;">
      <div style="height:100vh; width:100vw; position:absolute;">
      </div>
      <div style="height:100vh; width:100vw; position:absolute; color:#FFF;">
        <img src="img/mute.png" style="position:absolute; top:0; bottom:0; left:0; right:0; margin:auto;">
      </div>
    </div>
    
    <!-- no audio device page -->
    <div id="divNoAudioDevice" style="z-index:5; display:none; height:100vh; width:100vw; position:absolute;">
      <div style="height:100vh; width:100vw; position:absolute; background:#000;">
      </div>
      <div style="height:100vh; width:100vw; position:absolute; color:#FFF;">
        <div style="position:absolute; width:400px; height:290px; top:0; bottom:0; left:0; right:0; margin:auto;">
          <img id="imgPower" src="img/power_green.png" style="position:absolute; left:0; right:0; margin:auto;">
          <div id="divDeviceSource" style="position:absolute; height:50px; width:100%; bottom:0px; display:table-cell; text-align: center; font-size:50px;">
          </div>
        </div>
      </div>
    </div>
    
    <!-- offline page -->
    <div id="divOffline" class="landscapeOnly" style="z-index:10; display:none; height:100vh; width:100vw; position:absolute; background:#000;">
      <div style="height:100vh; width:100vw; position:absolute;">
      </div>
      <div style="height:100vh; width:100vw; position:absolute; color:#FFF;">
        <img src="img/disconnected.png" style="position:absolute; top:0; bottom:0; left:0; right:0; margin:auto;">
      </div>
    </div>

    <div id="divDebug" style="z-index:90; pointer-events: none; height:100vh; width:100vw; position:absolute; color:#FF0; font-size: 30px;">
    </div>

    <script>
      var socket = io();
      var settings = {};
      var state = {state:0, position:0};
      var unique = 0;
      var track = {duration:0};
      var touchScreen = isTouchDevice();
      var timer = 0, actSecsAt = -1, actSecsLeft = -1;
      var actPosition = 0, actDuration = 0;
      var dragPos = false, dragPosActive = false, dragVolume = false, dragVolumeActive =  false, actVolume = 0, actPosition = 0;
      var dragVolumeActiveTimeout = 0, dragPosActiveTimeout = 0, repeatActiveTimeout = 0, shuffleActiveTimeout = 0;
      var repeat = 0, shuffle = 0, repeatActive = false, shuffleActive = false, playerActive = true;
      var playlist = {"id_low":0, "id_high":0};
      var ratingTouched = false, artist = null, artistAlbum = null, playlistAlbum = null;
      var actTracksPlaylistsLow = 0, actTracksPlaylistsHigh = 0;
      var volDevialet = true;
      var actVolumeDigits = '';
      var hideVolumeDigitsOverlayTimeout = 0;
      var csecond = 0, interval = 1000;
      var actAudioDevicePresent = 2;
      var actAudioDeviceSource = '';
      var actAudioDeviceMute = 0;
      var msgHideTimeout;
      var currentArtwork = 1, showArtwork = 0;
      var loadingArtwork = false;


      window.onerror = function(err) {
        console.log(err);
        debug(err + ' '  + err.stack);
      }

      function debug(msg) {
        $('#divDebug').append(`<div style="background:#000;">${msg}</div>`);
        socket.emit('log', msg);
      }

      function isTouchDevice() {
        var el = document.createElement('div');
        el.setAttribute('ontouchstart', 'return;');
        return typeof el.ontouchstart === "function";
      }
      
      function formatTime(secs) {

        var days = Math.floor(secs / 60 / 60 / 24);
        secs -= days * 60 * 60 * 24;

        var h = Math.floor(secs / 60 / 60);
        secs -= h * 60 * 60;
      
        var min = Math.floor(secs / 60);
        secs -= min * 60;
        
        var stxt =  secs.toString();
        
        if(stxt.length < 2)
          stxt = '0'+stxt;

        var smin =  min.toString();
        
        if(h && smin.length < 2)
          smin = '0'+smin;

        var htxt =  h.toString();
        
        var text = smin+':'+stxt;

        if(h)
          text = htxt + ':' + text;
          
         if(days)
          text = days + ' days ' + text;
                        
        return(text);
      }

      function displayTime(position) {
        actPosition = position;
        
        var secsAt = Math.floor(position / 10);

		    if(secsAt != actSecsAt) {
	        $('#tdAt').html(formatTime(secsAt));
          actSecsAt = secsAt;
		    }
        
        var left = state.duration * 10 - position;
        
        if(left < 0)
          left = 0;

        var secsLeft = Math.ceil(left / 10);
          
        if(secsLeft != actSecsLeft) {
          $('#tdLeft').html('-'+formatTime(secsLeft));
          actSecsLeft = secsLeft;
        }
    
        $('#divTime').css('width', (position / state.duration * 10)+'%');
      }
                  
      function displayVolume(volume) {
        actVolume = volume;
        $('#divVolume').css('width', volume+'%');
      }
      
      function onSecond() {
        csecond ++;
        csecond = Math.min(csecond, state.duration * 10);
        
        if(csecond < state.position * 10) {
          if(interval != 90) {
            clearInterval(timer);
            interval = 90;
            timer = setInterval(onSecond, interval);
           }
        }
        else if(csecond > state.position * 10 + 10) {
          if(interval != 110) {
            clearInterval(timer);
            interval = 110;
            timer = setInterval(onSecond, interval);
          }
        }
        else if(interval != 100) {
          clearInterval(timer);
          interval = 100;
          timer = setInterval(onSecond, interval);
        }
        
        if(!dragPosActive)
          displayTime(csecond);
      }
      
      function displayShuffle(s) {
        shuffle = s;
      
        if(shuffle)
          $('#tdShuffle').css('background-color', 'rgba(128,128,128,0.5)');
        else
          $('#tdShuffle').css('background-color', '');
      }
      
      function displayRepeat(r) {
        repeat = r;
      
        if(repeat)
          $('#tdRepeat').css('background-color', 'rgba(128,128,128,0.5)');
        else
          $('#tdRepeat').css('background-color', '');
        
        if(repeat==1)
          $('#imgRepeat').attr('src', 'img/repeatl.png');
        else
          $('#imgRepeat').attr('src', 'img/repeat.png');
      }
      
      socket.on('reconnect_attempt', function() {
        $('#divOffline').show();
        console.log('reconnect_attempt');
      });

      socket.on('connect', function() {
        itunes.playLists();
        console.log('connect');
      });

      socket.on('reconnect', function(attempt) {
        $('#divOffline').hide();
        itunes.playLists();
        console.log('reconnect '+attempt);
      });

      socket.on('error', function(err) {
        console.log('socket', err);
        debug('socket ' + err + ' '  + err.stack);
      });

      socket.on('settings', function(msg){
        settings = msg;

        if(settings.dsp) {
          $('#imgDSP').attr("src", "img/dsp_on.png");
        } else {
          $('#imgDSP').attr("src", "img/dsp_off.png");
        }
      });
      
      socket.on('deviceState', function(msg){
        if(actAudioDevicePresent == msg.state && 
           actAudioDeviceSource  == msg.source &&
           actAudioDeviceMute    == msg.mute)
          return;
          
        if(msg.state == 2 && actAudioDevicePresent !=2) {
          itunes.playLists();
        }

        actAudioDevicePresent = msg.state;
        actAudioDeviceSource  = msg.source;
        
        if(msg.mute != actAudioDeviceMute) {
          actAudioDeviceMute    = msg.mute;

          if(actAudioDeviceMute) {
          
            $('#divAudioDeviceMute').show();
          } else {
          
            $('#divAudioDeviceMute').hide();
          }
          
        }
        
        switch(msg.state) {
          case -1:// off
            $('#imgPower').attr('src', 'img/power_grey.png');
            $('#divDeviceSource').html('');
            $('#divNoAudioDevice').show(); 
            break;
            
          case 0: // wrong source
            $('#imgPower').attr('src', 'img/power_grey.png');
            $('#divDeviceSource').html(msg.source);
            $('#divNoAudioDevice').show(); 
            break;
            
          case 1: // starting
            $('#imgPower').attr('src', 'img/power_green.png');
            $('#divDeviceSource').html('');
            $('#divNoAudioDevice').show(); 
            break;
            
          case 2: // active
            $('#divNoAudioDevice').hide(); 
            break;
        }
      });

      socket.on('state', function(msg){
      
        var oldState = state.state;
      
        state = msg;
        
        if(state.state && !oldState) {
          $('#btnPlay').attr('src', 'img/pause.png'); 
          
          csecond = msg.position * 10;
          
          if(!dragPosActive)
            displayTime(csecond);
          
          interval = 100;
          timer = setInterval(onSecond, interval);
        }
        else if(!state.state && oldState) {
          $('#btnPlay').attr('src', 'img/play.png');
          clearInterval(timer);
          
          if(csecond != msg.position * 10) {
            csecond = msg.position * 10;
          
            if(!dragPosActive)
              displayTime(csecond);
          }
        }

        // show next artwork?
        if(state.id_low == track.id_low && state.id_high == track.id_high) {

          showArtwork = Math.ceil(state.position / track.duration * Math.min(10, track.artworks));
    
          if(track.kind == 3 || !showArtwork) {	// radio
            showArtwork = 1;
          }

          if(showArtwork != currentArtwork) {

            var unique = track.album + track.trackCount;
            if(track.kind == 3) {
              unique = track.name;
            }
            if(showArtwork > 1) {
              unique += track.trackNumber;
            }

            var fadeTime = 5000;

            (function() {
              if(showArtwork == 1) {
                if(loadingArtwork)
                  return;

                fadeTime = 0;
              }

              $('#artwork' + currentArtwork).stop().fadeOut(fadeTime);
              currentArtwork = showArtwork;
              $('#artwork' + currentArtwork).attr('src', 'img/current' + currentArtwork + '.png?unique=' + unique+track.trackNumber).stop().fadeIn(fadeTime);
            })();
          }	
        }

        // adjust time display
        if(csecond < state.position * 10 - 10 || 
           csecond > state.position * 10 + 20) {
           
          csecond = state.position * 10;
          
          if(state.state) {
            clearInterval(timer);
            interval = 100;
            timer = setInterval(onSecond, interval);
          }
          
          if(!dragPosActive)
            displayTime(csecond);
        }

        if(!dragVolumeActive) {
          displayVolume(state.volume);
        }
          
        if(state.volumeDigits) {
          volDevialet = false;
          
          if(actVolumeDigits != state.volumeDigits) {
            actVolumeDigits = state.volumeDigits;
            $('#divVolumeDigits').css('display','').html(state.volumeDigits);              
          }
        }

        if(!repeatActive)          
          displayRepeat(state.repeat);
          
        if(!shuffleActive)
          displayShuffle(state.shuffle);
      });

      socket.on('track', function(msg){

        track = msg;
        
        if(!track.name) {
          $('.tdNow').css('visibility', 'hidden');
          
          if($(window).width() > $(window).height()) {
            $('#divNoTrack').fadeIn();
          }          
          
          if(touchScreen && playerActive)
            playerBack(null, true);
            
          markPlayingTrack();
          return;
        }

        $('.tdNow').css('visibility', 'visible');

        if($(window).width() > $(window).height()) {
          $('#divNoTrack').fadeOut();
        }
                
        $('#track').html(msg.name);
        
        if(track.kind != 3)
          $('#album_artist').html(msg.artist + ' - ' + msg.album);
        else
          $('#album_artist').html(msg.album);
        
        var unique = track.album + track.trackCount;
        if(track.kind == 3) {
          unique = track.name;
        }

        $('#artwork1').bind('load', function() {
          loadingArtwork = false;
          if(showArtwork == 1 && currentArtwork != 1) {
            $('#artwork' + currentArtwork).stop().fadeOut(0);
            currentArtwork = 1;
            $('#artwork1').stop().fadeIn(0);
          }
        });
        loadingArtwork = true;
        $('#artwork1').attr('src', 'img/current1.png?unique=' + unique);

        $('#artwork_album').attr('src', 'img/current1.png?unique=' + unique);
        $('#albumName').html(msg.album);        
        if(msg.albumArtist != '') $('#albumArtist').html(msg.albumArtist);
        else                      $('#albumArtist').html(msg.artist);
        $('#albumYear').html(msg.year);
        $('#trackQuality').html(msg.type);
        $('#trackSampleRate').html('Sample Rate: '+msg.sampleRate/1000+' kHz');
        $('#trackComposer').html('Composer: '+msg.composer);
        $('#trackBitRate').html('Bit Rate: '+msg.bitRate+' kbps');
        $('#trackPlayedCount').html(msg.playedCount);
        $('#trackComment').html(msg.comment);
/*
        $('#artist').html(msg.id_low);
        $('#album').html(msg.id_high);
*/
        displayRating(track.rating);
                        
        if(track.kind != 3) {
          $('#tablePosition').css('display', '');
          $('#tdAlbum').css('visibility', 'visible');
        }
        else {
          $('#tablePosition').css('display', 'none');
          $('#tdAlbum').css('visibility', 'hidden');
        }
                        
        markPlayingTrack();        
      });
          
      function displayRating(rating) {
        var srating = '<span style="cursor:pointer;" onTouchStart="onRate(event, 0, true)" onClick="onRate(event, 0, true)">&nbsp;&nbsp;&nbsp;</span>';
        
        for(r=0; r<rating; r+=20)
          srating+='<span style="cursor:pointer;" onTouchStart="onRate(event, '+(r+20)+', true)" onClick="onRate(event, '+(r+20)+', true)">&#x2605</span>';
          
        for(; r<100; r+=20)
          srating+='<span style="cursor:pointer;" onTouchStart="onRate(event, '+(r+20)+', true)" onClick="onRate(event, '+(r+20)+', true)">&#x2606</span>';
        
        srating += '&nbsp&nbsp;&nbsp;';
        
        $('#trackRating').html(srating);
      }
          
      function onRate(e, rating, touched) {
        if(touchScreen && !touched)
          return;
          
        var o = $('#divTrackInfo').css('opacity');
        if(o == '0')
          return;
          
        itunes.setRating(track.id_low, track.id_high, rating);
        displayRating(rating);

        e.stopImmediatePropagation();
      }
                
      function onPlay(touched) {
        if(touchScreen && !touched)
          return;
          
        $('#tdPlay').css('background-color', '#A90');
      
        clearTimeout(dragVolumeActiveTimeout);
        dragVolumeActive = true;
        dragVolumeActiveTimeout = setTimeout(function(){dragVolumeActive = false;}, 1000);
      
        if(state.state) {
          itunes.pause();
          $('#btnPlay').attr('src', 'img/play.png');
          }
        else {
          itunes.play();
          $('#btnPlay').attr('src', 'img/pause.png');
          }
      }
          
      function endPlay(touched) {
        if(touchScreen && !touched)
          return;
          
        $('#tdPlay').css('background-color', '');
      }
      
      function onPrev(touched) {
        if(touchScreen && !touched)
          return;
          
        $('#tdPrev').css('background-color', '#A90'); 
        
        clearTimeout(dragVolumeActiveTimeout);
        dragVolumeActive = true;
        dragVolumeActiveTimeout = setTimeout(function(){dragVolumeActive = false;}, 1000);
        
        itunes.backTrack();
      }
      
      function endPrev(touched) {
        if(touchScreen && !touched)
          return;
          
        $('#tdPrev').css('background-color', '');
      }
      
      function onNext(touched) {
        if(touchScreen && !touched)
          return;      
          
        $('#tdNext').css('background-color', '#A90'); 
        
        clearTimeout(dragVolumeActiveTimeout);
        dragVolumeActive = true;
        dragVolumeActiveTimeout = setTimeout(function(){dragVolumeActive = false;}, 1000);

        itunes.nextTrack();
      }
      
      function endNext(touched) {
        if(touchScreen && !touched)
          return;
          
        $('#tdNext').css('background-color', '');
      }
      
      function onPosition(touched, ev) {
        if(touchScreen && !touched)
          return;

        var pos;

        if(ev.changedTouches)
          pos = ev.changedTouches[0].pageX - $('#tdBar').offset().left;
        else
          pos = ev.offsetX;
         
        var width = $('#tdBar')[0].offsetWidth;
        var position = Math.round(pos / width * track.duration * 10);
        
        if(position > track.duration * 10)
          position = track.duration * 10;
        
        if(position < 0)
          position = 0;
          
        displayTime(position);
        
        clearTimeout(dragPosActiveTimeout);
        dragPosActive = true;
        dragPos = true;
      }
      
      function onPositionMove(touched, ev) {
        if(!dragPos || (touchScreen && !touched))
          return;

        onPosition(touched, ev);
      }
      
      function endPosition(touched) {
        if(!dragPos || (touchScreen && !touched))
          return;
          
        itunes.setPlayerPosition(Math.floor(actPosition / 10));
        dragPos = false;
        
        dragPosActiveTimeout = setTimeout(function(){dragPosActive = false;}, 1000);
        
        clearTimeout(dragVolumeActiveTimeout);
        dragVolumeActive = true;
        dragVolumeActiveTimeout = setTimeout(function(){dragVolumeActive = false;}, 1000);
      }
      
      function onVolume(touched, ev) {

        if(touchScreen && !touched)
          return;

        if(ev.changedTouches)
          dragVolume = ev.changedTouches[0].pageX - $('#tdVolume').offset().left;
        else
          dragVolume = ev.offsetX;

        var widthTouchArea = $('#tdVolume')[0].offsetWidth;
        var widthSlider    = $('#divVolumeSlider')[0].offsetWidth;

        dragVolume -= widthTouchArea - widthSlider;
        dragVolume = Math.round(dragVolume / widthSlider * 100);
        startVolume = actVolume;

        clearTimeout(dragVolumeActiveTimeout);
        dragVolumeActive = true;
      }
      
      function onVolumeMove(touched, ev) {
        if(!dragVolume || (touchScreen && !touched))
          return;

          var pos;

          if(ev.changedTouches)
            pos = ev.changedTouches[0].pageX - $('#tdVolume').offset().left;
          else
            pos = ev.offsetX;

          var widthTouchArea = $('#tdVolume')[0].offsetWidth;
          var widthSlider    = $('#divVolumeSlider')[0].offsetWidth;

          pos -= widthTouchArea - widthSlider;

          var volume = Math.round(pos / widthSlider * 100);

          volume = startVolume + volume - dragVolume;

          if(volume > 100)
            volume = 100;

          if(volume < 0)
            volume = 0;
            
          displayVolume(volume);
          itunes.setSoundVolume(actVolume);

      }
      
      function endVolume(touched) {
        if(!dragVolume || (touchScreen && !touched))
          return;
          
        itunes.setSoundVolume(actVolume);
        dragVolumeActiveTimeout = setTimeout(function(){dragVolumeActive = false;}, 1000);
        dragVolume = false;
      }
      
      function onAlbum(e, touched) {
        if(touchScreen && !touched)
          return;
        
        $('#divAlbumTracklist').scrollTop(0);
        itunes.albumTracks(track, 1);
        
        $('#divAlbum').animate({"top":"0px"});
        $('#divPlayer').animate({"top":"-100vh"});
        
        e.stopImmediatePropagation();
        e.preventDefault();
      }
      
      socket.on('albumTracks', function(resp){
        var tracks = resp.tracks;
        var $table = 0;
        
        switch(resp.ref) {
          case 1: $table = $('#tableAlbumTracks'); $div =$('#divAlbumTracklist'); break;
          case 2: $table = $('#tableArtistAlbum'); $div = $('#divArtistAlbums'); break;
          case 3: $table = $('#tablePlaylistAlbum'); $div = $('#divPlaylistAlbum'); break;
          case 4: $table = $('#tableSearchedAlbum'); $div = $('#divSearchedAlbums'); break;
        }
        
        $table.find("tr").remove();
        
        for(var i=0; i<tracks.length; i++) {
          var tr = tracks[i];
          var rating = "";
          
          for(r=0; r<tr.rating; r+=20)
            rating+='&#x2605';

          var interpret = '';
          if( (tr.albumArtist != '' && tr.albumArtist != tr.artist) || tr.compilation) {
            interpret = '<span class="tdTrackArtist">' + tr.artist + '</span><br>';
          }

          var duration = formatTime(tr.duration);
          var oTr = $.parseHTML('<tr class="trTrack" style="border-bottom:4px solid #000;" onClick="onAlbumTrack('+tr.id_low+', '+tr.id_high+')"><td class="tdTrackNumber"><div class="divAlbumTrackNr_'+tr.id_low+'_'+tr.id_high+'">'+tr.trackNumber+'</div><div class="divAlbumTrackPlay_'+tr.id_low+'_'+tr.id_high+'"><img src="img/playing.png"></div></td><td class="tdTrackInfo"><span class="tdTrackName">'+tr.name+'</span><br>'+interpret+duration+' '+rating+'</td></tr>');
          $table.append(oTr);
        }

        markPlayingTrack();
        
        // bug fix iOS 11.1.1 did often not scroll
        $div.css('-webkit-overflow-scrolling', '');
        
        setTimeout(function()
          {
          $div.css('-webkit-overflow-scrolling', 'touch');
          }, 10);
      });
      
      function markPlayingTrack() {
        $('div[class^=divAlbumTrackNr_]').show();
        $('div[class^=divAlbumTrackPlay_]').hide();
        $('.divAlbumTrackNr_'+track.id_low+'_'+track.id_high).hide();
        $('.divAlbumTrackPlay_'+track.id_low+'_'+track.id_high).show();
      }
      
      function albumBack(e, touched) {
        if(touchScreen && !touched)
          return;
          
        $('#divAlbum').animate({"top":"100vh"});
        $('#divPlayer').animate({"top":"0"});
        
        if(e) {
          e.stopImmediatePropagation();
          e.preventDefault();
        }
      }
        
      function onTracksPlaylists(e, touched) {
        if(touchScreen && !touched)
          return;
        
        $('#divTracksPlaylistsList').scrollTop(0);
        
        if(actTracksPlaylistsLow != track.id_low || actTracksPlaylistsHigh != track.id_high) {
          $("#tableTracksPlaylists tr").remove();
          itunes.tracksPlaylists(track);
          actTracksPlaylistsLow  = track.id_low;
          actTracksPlaylistsHigh = track.id_high;
        }
        
        $('#divTracksPlaylists').animate({"top":"0px"});
        $('#divPlayer').animate({"top":"-100vh"});
        
        e.stopImmediatePropagation();
        e.preventDefault();
      }
      
      socket.on('tracksPlaylists', function(playlists){
        var $table = $('#tableTracksPlaylists');
        
        $("#tableTracksPlaylists tr").remove();
        
        for(var i=0; i<playlists.length; i++) {
          var li = playlists[i];

          var htmlIncluded = 'blank.png';

          if(li.included)
            htmlIncluded = 'checkmark.png';

          $table.append('<tr class="trTrack" style="border-bottom:4px solid #000;" onClick="toggleTrackInList('+i+', '+li.id_low+', '+li.id_high+', '+li.included+')"><td class="tdTrackNumber"><img src="img/playlist_icon.png"></td><td class="tdTrackInfo"><span class="tdTrackName">'+li.name+'</span><br>'+li.count+' Items, '+formatTime(li.duration)+'</td><td class="tdTrackInfo"><img id="imgIncluded'+i+'" src="img/'+htmlIncluded+'"></td></tr>');
        }
      });
      
      function toggleTrackInList(i, id_low, id_high, included) {
        $('#imgIncluded'+i).attr('src', 'img/busy.gif');
      
        if(included)
          itunes.removeTrackFromList({"track":track, "id_low":id_low, "id_high":id_high});
        else
          itunes.addTrackToList({"track":track, "id_low":id_low, "id_high":id_high});
      }
      
      function tracksPlaylistsBack(e, touched) {
        if(touchScreen && !touched)
          return;
          
        $('#divTracksPlaylists').animate({"top":"100vh"});
        $('#divPlayer').animate({"top":"0"});
        
        e.stopImmediatePropagation();
        e.preventDefault();
      }
        
      function onRepeat(touched) {
        if(touchScreen && !touched)
          return;
      
        repeat ++;
        if(repeat > 2)
          repeat = 0;
          
        displayRepeat(repeat);
        itunes.setRepeat(repeat);
         
        repeatActive = true;
        clearTimeout(repeatActiveTimeout);
        repeatActiveTimeout = setTimeout(function(){repeatActive = false;}, 1000);
      }
      
      function onDSP(touched) {
        if(touchScreen && !touched)
          return;

        settings.dsp = !settings["dsp"];

        if(settings.dsp) {
          $('#imgDSP').attr("src", "img/dsp_on.png");
        } else {
          $('#imgDSP').attr("src", "img/dsp_off.png");
        }

        itunes.setDSP(settings.dsp);
        itunes.settings(settings);
      }

      function onShuffle(touched) {
        if(touchScreen && !touched)
          return;
      
        shuffle ++;
        if(shuffle > 1)
          shuffle = 0;
          
        displayShuffle(shuffle);
        itunes.setShuffle(shuffle);
         
        shuffleActive = true;
        clearTimeout(shuffleActiveTimeout);
        shuffleActiveTimeout = setTimeout(function(){shuffleActive = false;}, 1000);
      }
        
      function onAlbumTrack(id_low, id_high) {
        track.id_low = id_low;
        track.id_high = id_high;
        markPlayingTrack();
        
        itunes.playAlbumFrom(id_low, id_high);
        albumBack(null, true);
        onNow(true);
      }
      
      function onSong(id_low, id_high) {
        itunes.playTrack(id_low, id_high);

        if(!state.state)
          onNow(true);
        else
          showMessage('Track queued');
      }

      function showMessage(txt) {

        if(msgHideTimeout) {
          clearTimeout(msgHideTimeout);
          msgHideTimeout = null;
        }

        $('#divMessage').css({"top":"-130px"});

        $('#spanMessage').html(txt);
        $('#divMessage').animate({"top":"0px"});

        msgHideTimeout = setTimeout(function() {
          msgHideTimeout = null;
          $('#divMessage').animate({"top":"-130px"});
        }, 3000);
      }

      function playerBack(e, touched) {
        if(touchScreen && !touched)
          return;
      
        $('#divPlayer').animate({"left":"100vw"});
        playerActive = false;
        
        if(e && touched) {
          e.stopImmediatePropagation();
          e.preventDefault();
        }
      }
      
      socket.on('playLists', function(lists){
        var $table = $('#tablePlaylists');
        
        $("#tablePlaylists tr").remove();
        
        for(var i=0; i<lists.length; i++) {
          var li = lists[i];
          
          var icon = 'icon';
          
          if(li.smart)
            icon = 'smart';
            
          switch(li.specialKind) {
            case 1: icon = 'shopped';  break;
            case 3: icon = 'podcasts'; break;
            case 6: icon = 'music';    break;
          }
          
          $table.append('<tr class="trTrack" style="border-bottom:4px solid #000;" onClick="onPlaylist('+li.id_low+', '+li.id_high+', \''+li.name+'\')"><td class="tdTrackNumber"><img src="img/playlist_'+icon+'.png"></td><td class="tdTrackInfo"><span class="tdTrackName">'+li.name+'</span><br>'+li.count+' Items, '+formatTime(li.duration)+'</td></tr>');
        }

        // load last playlist on startup
        if($(window).width() < $(window).height()) {
          var playlistCfg = getCookie("playlist");
          if(playlistCfg) {
            onPlaylist(playlistCfg.id_low, playlistCfg.id_high, playlistCfg.name);
          }
        }

      });
      
      function onNow(touched) {
        if(touchScreen && !touched)
          return;
          
        $('#divPlayer').animate({"left":"0"});
        playerActive = true;
      }
      
      function onPlaylist(id_low, id_high, name) {

        setCookie("playlist", {id_low, id_high, name});

        playlist.mode = 0;
        playlist.sortOrder = 0;
        playlist.name = name;
        playlist.id_low  = id_low;
        playlist.id_high = id_high;
      
        var key = 'pl_'+id_low+'_'+id_high;
        
        if( settings.playlists[key] ) {
          if( settings.playlists[key]['mode'] )
            playlist.mode = settings.playlists[key].mode;
            
          if( settings.playlists[key]['sortOrder'] )
            playlist.sortOrder = settings.playlists[key].sortOrder;
        }
        
        $("#tablePlaylist tr").remove();
        
        playlist.loaded = 0;
        itunes.playlistTracks(playlist.id_low, playlist.id_high, 0, playlist.mode, playlist.sortOrder);
        
        $('#tdPlaylistsTitle').html(name);
        $('#imgPlaylistsBack').css('visibility', 'visible');
        $('#divPlaylist').scrollTop(0);
        $('#divPlaylist').animate({"left":"0"});
        $('#divPlaylists').animate({"left":"-100vw"});
      }
      
      function onPlaylistLoadMore() {
        $('#tablePlaylist .loadMore').css("background-color", "#0AF");
        itunes.playlistTracks(playlist.id_low, playlist.id_high, playlist.loaded, playlist.mode, playlist.sortOrder);
      }

      function onPlaylistsBack(touched) {
        if(touchScreen && !touched)
          return;
          
        if(playlistAlbum) {
          playlistAlbum = null;
          removeCookie("playlistAlbum");
          
          $('#tdPlaylistsTitle').html(playlist.name).css('font-size', 60);
          
          $('#divPlaylistAlbum').animate({"left":"100vw"}, function() {
            $("#tablePlaylistAlbum tr").remove();
          });
          
          $('#divPlaylist').animate({"left":"0"});
        } else {
          removeCookie("playlist");

          $('#tdPlaylistsTitle').html("Playlists");
          $('#imgPlaylistsBack').css('visibility', 'hidden');
          
          $('#divPlaylist').animate({"left":"100vw"}, function() {
            $("#tablePlaylist tr").remove();
          });
          
          $('#divPlaylists').animate({"left":"0"});
        }
      }

      function onPlaylistSortOrder() {
        $("#tablePlaylist tr").remove();
        
        if(playlist.sortOrder)
          playlist.sortOrder = 0;
        else
          playlist.sortOrder = 1;
        
        var key = 'pl_'+playlist.id_low+'_'+playlist.id_high;
        
        if( !settings.playlists[key] )
          settings.playlists[key] = {};
        
        settings.playlists[key].sortOrder = playlist.sortOrder;
        itunes.settings(settings);
        
        playlist.loaded = 0;
        itunes.playlistTracks(playlist.id_low, playlist.id_high, 0, playlist.mode, playlist.sortOrder);
      }

      function onPlaylistMode() {
        $("#tablePlaylist tr").remove();
        
        if(playlist.mode)
          playlist.mode = 0;
        else
          playlist.mode = 1;
        
        var key = 'pl_'+playlist.id_low+'_'+playlist.id_high;
        
        if( !settings.playlists[key] )
          settings.playlists[key] = {};
        
        settings.playlists[key].mode = playlist.mode;
        itunes.settings(settings);
        
        playlist.loaded = 0;
        itunes.playlistTracks(playlist.id_low, playlist.id_high, 0, playlist.mode, playlist.sortOrder);
      }
      
      socket.on('playlistTracks', function(tracks){
        var $table = $('#tablePlaylist');
        
        if(!playlist.loaded) {
          $("#tablePlaylist").append('<tr class="trTrack" style="border-bottom:4px solid #000;"><td class="tdTrackNumber"></td><td class="tdTrackInfo" colspan=2><img src="img/shuffle_b.png" onClick="onPlaylistTrack(-1)"><img id="imgPlaylistSortOrder" src="img/sortOrder.png" style="padding-left:20px;" onClick="onPlaylistSortOrder()"><img id="imgPlaylistMode" src="img/album.png" style="padding-left:20px;" onClick="onPlaylistMode()"></td></tr>');
          
          if(playlist.sortOrder)
            $('#imgPlaylistSortOrder').prop('src', 'img/sortOrder_active.png');
          
          if(playlist.mode)
            $('#imgPlaylistMode').prop('src', 'img/album_active.png');
        }

        for(var i=0; i<tracks.length; i++) {
        
          var tr = tracks[i];

          if(tr.toBeContinued) {
            $table.append('<tr class="trTrack loadMore" style="border-bottom:4px solid #000;" onClick="onPlaylistLoadMore()"><td class="tdTrackNumber"></td><td class="tdTrackInfo"><span class="tdTrackName">'+tr.name+'</span><td class="tdTrackInfo"></td></tr>');
          } else {
            var rating = "";
            
            for(r=0; r<tr.rating; r+=20)
              rating+='&#x2605';
            
            if(playlist.mode) {   // list by album
              var artist = tr.artist;
              
              if(tr.compilation)
                artist = 'Various';
            
              var $tr = $('<tr class="trTrack" style="border-bottom:4px solid #000;"><td class="tdTrackNumber"><img style="width:200px;" src="thumbs/cover~'+tr.id_low+'~'+tr.id_high+'~'+tr.name+'~'+tr.artist+'~'+tr.compilation+'~'+tr.trackCount+'~0~.png"></td><td class="tdTrackInfo" colspan=2><span class="tdTrackName">'+tr.name+'</span><br><span class="tdTrackAlbum">'+artist+' '+tr.year+'</span> '+rating+'</td></tr>');
              
              (function() {
                var al_ = tr;
                $tr.click( function() {
                  onPlaylistAlbum(al_.id_low, al_.id_high, al_.name);
                });
              })();
              
              $table.append($tr);
            } else {              // list by track
              var duration = formatTime(tr.duration);
              
              if(tr.kind == 3)  // radio
                $table.append('<tr class="trTrack" style="border-bottom:4px solid #000;" onClick="onPlaylistTrack('+playlist.loaded+')"><td class="tdTrackNumber"><img style="width:200px;" src="thumbs/cover~'+tr.id_low+'~'+tr.id_high+'~'+ tr.name + '~no_artist~false~0~'+tr.kind+'~.png"></td><td class="tdTrackInfo"><span class="tdTrackName">'+tr.name+'</span><br>'+rating+'</td><td class="tdTrackInfo"><div class="divAlbumTrackPlay_'+tr.id_low+'_'+tr.id_high+'"><img src="img/playing.png"></div></td></tr>');
              else
                $table.append('<tr class="trTrack" style="border-bottom:4px solid #000;" onClick="onPlaylistTrack('+playlist.loaded+')"><td class="tdTrackNumber"><img style="width:200px;" src="thumbs/cover~'+tr.id_low+'~'+tr.id_high+'~'+ tr.album +'~'+tr.artist+'~'+tr.compilation+'~'+tr.trackCount+'~'+tr.kind+'~.png"></td><td class="tdTrackInfo"><span class="tdTrackName">'+tr.name+'</span><br><span class="tdTrackAlbum">'+tr.album+' - '+tr.artist+'</span><br>'+duration+' '+rating+'</td><td class="tdTrackInfo"><div class="divAlbumTrackPlay_'+tr.id_low+'_'+tr.id_high+'"><img src="img/playing.png"></div></td></tr>');
            }
            playlist.loaded++;
          }
          
          if(i==0)
            $('#tablePlaylist .loadMore').remove();
        }
        
        // bug fix iOS 11.1.1 did often not scroll
        $('#divPlaylist').css('-webkit-overflow-scrolling', '');
        
        setTimeout(function()
          {
          $('#divPlaylist').css('-webkit-overflow-scrolling', 'touch');
          }, 10);
        
        markPlayingTrack();
      });
      
      function onPlaylistTrack(idx) {
      
        if(idx == -1) {
          itunes.playTrackInList(playlist.id_low, playlist.id_high, -1);
        } else {
          itunes.playTrackInList(playlist.id_low, playlist.id_high, idx, playlist.sortOrder);
        }
        onNow(true);
      }

      function onTrackInfo(e, touched) {
        if(touchScreen && !touched)
          return;
          
        var o = $('#divTrackInfo').css('opacity');
        
        if(o == '0')
          $('#divTrackInfo').css('opacity', '1');
        else
          $('#divTrackInfo').css('opacity', '0');
          
        e.stopImmediatePropagation();
        e.preventDefault();
      }
      
      function resetMainMenu() {
        $('#imgMainPlaylists').attr('src', 'img/playlist.png');
        $('#imgMainArtists').attr('src', 'img/interpret.png');
        $('#imgMainAlbums').attr('src', 'img/album.png');
        $('#imgMainSongs').attr('src', 'img/song.png');
        $('#imgMainComposers').attr('src', 'img/composer.png');
        
        $('#tabPlaylists').css('display', 'none');
        $('#tabArtists').css('display', 'none');
        $('#tabAlbums').css('display', 'none');
        $('#tabSongs').css('display', 'none');
        $('#tabcomposers').css('display', 'none');
      }
      
      function onMainPlaylists(touched) {
        if(touchScreen && !touched)
          return;

        resetMainMenu();
        $('#imgMainPlaylists').attr('src', 'img/playlist_active.png');
        $('#tabPlaylists').css('display', '');
      }
                  
      function onMainArtists(e, touched) {
        if(touchScreen && !touched)
          return;
        
        if($('#tabArtists').css('display') != 'none') {
          if(artistAlbum) onArtistsBack(true);
          if(artist)      onArtistsBack(true);
          $('#inputSearchArtists').val('').focus();
          $("#tableArtists tr").remove();          
        } else {
          resetMainMenu();
          $('#imgMainArtists').attr('src', 'img/interpret_active.png');
          $('#tabArtists').css('display', '');
          
          if($('#inputSearchArtists').val() == '')
            $('#inputSearchArtists').focus();
        } 
        
        e.stopImmediatePropagation();
        e.preventDefault();
      }
      
      function onMainSongs(e, touched) {
        if(touchScreen && !touched)
          return;
        
        if($('#tabSongs').css('display') != 'none') {
          $('#inputSearchSongs').val('').focus();
          $("#tableSongs tr").remove();          
        } else {
          resetMainMenu();
          $('#imgMainSongs').attr('src', 'img/song_active.png');
          $('#tabSongs').css('display', '');
          
          if($('#inputSearchSongs').val() == '')
            $('#inputSearchSongs').focus();
        } 
        
        e.stopImmediatePropagation();
        e.preventDefault();
      }
      
      function onMainAlbums(e, touched) {
        if(touchScreen && !touched)
          return;
        
        if($('#tabAlbums').css('display') != 'none') {
          $('#inputSearchAlbums').val('').focus();
          $("#tableAlbums tr").remove();          
        } else {
          resetMainMenu();
          $('#imgMainAlbums').attr('src', 'img/album_active.png');
          $('#tabAlbums').css('display', '');
          
          if($('#inputSearchAlbums').val() == '')
            $('#inputSearchAlbums').focus();
        } 
        
        e.stopImmediatePropagation();
        e.preventDefault();
      }

      function onKeySearchArtist(e) {
        var val = $('#inputSearchArtists').val();
        
        if(val.length < 3) {
          removeCookie("searchArtist");
          $("#tableArtists tr").remove();
          return;
        }
          
        setCookie("searchArtist", val);
        itunes.search(2, val);
      }

      // load last artist search string
      if($(window).width() < $(window).height()) {
        var searchArtistCfg = getCookie("searchArtist");
        if(searchArtistCfg) {
          $('#inputSearchArtists').val(searchArtistCfg);
          itunes.search(2, searchArtistCfg);
        }
      }

      function onKeySearchSong(e) {
        var val = $('#inputSearchSongs').val();
        
        if(val.length < 3) {
          removeCookie("searchSong");
          $("#tableSongs tr").remove();
          return;
        }
          
        setCookie("searchSong", val);
        itunes.search(5, val);
      }

      // load last song search string
      if($(window).width() < $(window).height()) {
        var searchSongCfg = getCookie("searchSong");
        if(searchSongCfg) {
          $('#inputSearchSongs').val(searchSongCfg);
          itunes.search(5, searchSongCfg);
        }
      }

      function onKeySearchAlbum(e) {
        var val = $('#inputSearchAlbums').val();
        
        if(val.length < 3) {
          removeCookie("searchAlbum");
          $("#tableAlbums tr").remove();
          return;
        }
          
        setCookie("searchAlbum", val);
        itunes.search(3, val);
      }

      // load last album search string
      if($(window).width() < $(window).height()) {
        var searchAlbumCfg = getCookie("searchAlbum");
        if(searchAlbumCfg) {
          $('#inputSearchAlbums').val(searchAlbumCfg);
          itunes.search(3, searchAlbumCfg);
        }
      }
      
      socket.on('searchResult', function(msg) {
        switch(msg.type) {
          case 2: searchResultArtists(msg.list);  break;
          case 3: searchResultAlbums(msg.list);  break;
          case 4: searchResultComposers(msg.list);  break;
          case 5: searchResultSongs(msg.list);  break;
        }
      });
      
      function jsEscape(text) {
        text = text.replace(/'/g, '`');
        text = text.replace(/"/g, '&quot;');
        return text;
      }

      function searchResultArtists(list) {
        var $table = $('#tableArtists');
        
        $("#tableArtists tr").remove();
        
        for(var i=0; i<list.length; i++) {
          var li = list[i];

          $table.append('<tr class="trTrack" style="border-bottom:4px solid #000; height:150px;" onClick="onArtist('+li.id_low+', '+li.id_high+', \''+jsEscape(li.name)+'\')"><td class="tdTrackInfo"><span class="tdTrackName">'+li.name+'</span></td></tr>');
        }
      }

      function searchResultSongs(tracks) {
        var $table = $('#tableSongs');
        
        $("#tableSongs tr").remove();
        
        for(var i=0; i<tracks.length; i++) {
          var tr = tracks[i];

          var rating = "";
          
          for(r=0; r<tr.rating; r+=20)
            rating+='&#x2605';
          
          var duration = formatTime(tr.duration);

          if(tr.kind == 3)  // radio
            $table.append('<tr class="trTrack" style="border-bottom:4px solid #000;" onClick="onSong('+tr.id_low+', '+tr.id_high+')"><td class="tdTrackNumber"><img style="width:200px;" src="thumbs/cover~'+tr.id_low+'~'+tr.id_high+'~'+ tr.name + '~no_artist~false~0~'+tr.kind+'~.png"></td><td class="tdTrackInfo"><span class="tdTrackName">'+tr.name+'</span><br>'+rating+'</td><td class="tdTrackInfo"><div class="divAlbumTrackPlay_'+tr.id_low+'_'+tr.id_high+'"><img src="img/playing.png"></div></td></tr>');
          else
            $table.append('<tr class="trTrack" style="border-bottom:4px solid #000;" onClick="onSong('+tr.id_low+', '+tr.id_high+')"><td class="tdTrackNumber"><img style="width:200px;" src="thumbs/cover~'+tr.id_low+'~'+tr.id_high+'~'+ tr.album +'~'+tr.artist+'~'+tr.compilation+'~'+tr.trackCount+'~'+tr.kind+'~.png"></td><td class="tdTrackInfo"><span class="tdTrackName">'+tr.name+'</span><br><span class="tdTrackAlbum">'+tr.album+' - '+tr.artist+'</span><br>'+duration+' '+rating+'</td><td class="tdTrackInfo"><div class="divAlbumTrackPlay_'+tr.id_low+'_'+tr.id_high+'"><img src="img/playing.png"></div></td></tr>');
          }

        // bug fix iOS 11.1.1 did often not scroll
        $('#divPlaylist').css('-webkit-overflow-scrolling', '');
        
        setTimeout(function()
          {
          $('#divPlaylist').css('-webkit-overflow-scrolling', 'touch');
          }, 10);

        markPlayingTrack();          
      }

      function searchResultAlbums(albums) { // one track per album
        var $table = $('#tableAlbums');

        $("#tableAlbums tr").remove();

        for(var i=0; i<albums.length; i++) {
          var al = albums[i];

          var rating = "";
            
          for(r=0; r<al.albumRating; r+=20) 
            rating+='&#x2605';

          var $tr = $('<tr class="trTrack" style="border-bottom:4px solid #000;"><td class="tdTrackNumber"><img style="width:200px;" src="thumbs/cover~'+al.id_low+'~'+al.id_high+'~'+al.album+'~'+al.artist+'~'+al.compilation+'~'+al.trackCount+'~0~.png"></td><td class="tdTrackInfo"><span class="tdTrackName">'+al.name+'</span><br><span class="tdTrackAlbum">'+al.year+'</span> '+rating+'</td></tr>');
          
          (function() {
            var al_ = al;
            $tr.click( function() {
              onSearchedAlbum(al_.id_low, al_.id_high, al_.name);
            });
          })();
          
          $table.append($tr);
        }
      }

      function onSearchedAlbum(id_low, id_high, name) {
        searchedAlbum = name;
        setCookie("searchedAlbum", {id_low, id_high, name});

        $("#tableSearchedAlbum tr").remove();
        
        itunes.albumTracks({"id_low":id_low, "id_high":id_high}, 4);
        
        $('#imgAlbumsBack').css('visibility', 'visible');
        $('#tdAlbumsTitle').html(artist).css('font-size', 40);
        $('#tdAlbumsTitle').html(name);
        $('#divSearchedAlbum').scrollTop(0);
        $('#divSearchedAlbum').animate({"left":"0"});
        $('#divAlbums').animate({"left":"-100vw"});
      }

      // inital load of last selected searched album
      if($(window).width() < $(window).height()) {
        var searchedAlbumCfg = getCookie("searchedAlbum");
        if(searchedAlbumCfg) {
          onSearchedAlbum(searchedAlbumCfg.id_low, searchedAlbumCfg.id_high, searchedAlbumCfg.name);
        }
      }

      function onAlbumsBack(touched) {
        if(touchScreen && !touched)
          return;
          
        removeCookie("searchedAlbum");

        searchedAlbum = null;
        $('#tdAlbumsTitle').html("Albums").css('font-size', 60);
        $('#imgAlbumsBack').css('visibility', 'hidden');
      
        $('#divSearchedAlbum').animate({"left":"100vw"}, function() {
          $("#tableSearchedAlbum tr").remove();
        });
      
        $('#divAlbums').animate({"left":"0"});
      }

      function onArtist(id_low, id_high, name) {
        artist = name;
        
        $("#tableArtistAlbums tr").remove();
        $("#tableArtistAlbums").append('<tr class="trTrack" style="border-bottom:4px solid #000;" onClick="onPlayArtistRandom()"><td class="tdTrackNumber"></td><td class="tdTrackInfo"><span class="tdTrackName"><img src="img/shuffle_b.png"></span></td></tr>');
        
        itunes.artistAlbums(id_low, id_high);
        
        $('#tdArtistsTitle').html(artist).css('font-size', 40);
        $('#imgArtistsBack').css('visibility', 'visible');
        $('#divArtistAlbums').scrollTop(0);
        $('#divArtistAlbums').animate({"left":"0"});
        $('#divArtists').animate({"left":"-100vw"});

        setCookie("artistsAlbums", {id_low, id_high, name});
      }
      
      // initial load of last selected artist
      if($(window).width() < $(window).height()) {
        var artistsAlbumsCfg = getCookie("artistsAlbums");
        if(artistsAlbumsCfg) {
          onArtist(artistsAlbumsCfg.id_low, artistsAlbumsCfg.id_high, artistsAlbumsCfg.name);
        }
      }

      socket.on('artistAlbums', function(albums){
        var $table = $('#tableArtistAlbums');

        for(var i=0; i<albums.length; i++) {
          var al = albums[i];

          var rating = "";
            
          for(r=0; r<al.rating; r+=20) 
            rating+='&#x2605';

          var $tr = $('<tr class="trTrack" style="border-bottom:4px solid #000;"><td class="tdTrackNumber"><img style="width:200px;" src="thumbs/cover~'+al.id_low+'~'+al.id_high+'~'+al.name+'~'+al.artist+'~'+al.compilation+'~'+al.trackCount+'~0~.png"></td><td class="tdTrackInfo"><span class="tdTrackName">'+al.name+'</span><br><span class="tdTrackAlbum">'+al.year+'</span> '+rating+'</td></tr>');
          
          (function() {
            var al_ = al;
            $tr.click( function() {
              onArtistAlbum(al_.id_low, al_.id_high, al_.name);
            });
          })();
          
          $table.append($tr);
        }
      });
      
      function onArtistsBack(touched) {
        if(touchScreen && !touched)
          return;
          
        if(artistAlbum) {

          removeCookie("artistsAlbum");

          artistAlbum = null;
          $('#tdArtistsTitle').html(artist);
        
          $('#divArtistAlbum').animate({"left":"100vw"}, function() {
            $("#tableArtistAlbum tr").remove();
          });
        
          $('#divArtistAlbums').animate({"left":"0"});

        } else {

          removeCookie("artistsAlbums");

          artist = null;
          $('#tdArtistsTitle').html("Artists").css('font-size', 60);
          $('#imgArtistsBack').css('visibility', 'hidden');
        
          $('#divArtistAlbums').animate({"left":"100vw"}, function() {
            $("#tableArtistAlbums tr").remove();
          });
        
          $('#divArtists').animate({"left":"0"});
        }   
      }
      
      function onArtistAlbum(id_low, id_high, name) {
        artistAlbum = name;
        setCookie("artistsAlbum", {id_low, id_high, name});

        $("#tableArtistAlbum tr").remove();
        
        itunes.albumTracks({"id_low":id_low, "id_high":id_high}, 2);
        
        $('#tdArtistsTitle').html(name);
        $('#divArtistAlbum').scrollTop(0);
        $('#divArtistAlbum').animate({"left":"0"});
        $('#divArtistAlbums').animate({"left":"-100vw"});
      }

      // inital load of last selected artists album
      if($(window).width() < $(window).height()) {
        var artistsAlbumCfg = getCookie("artistsAlbum");
        if(artistsAlbumCfg) {
          onArtistAlbum(artistsAlbumCfg.id_low, artistsAlbumCfg.id_high, artistsAlbumCfg.name);
        }
      }

      function onPlaylistAlbum(id_low, id_high, name) {
        playlistAlbum = name;
        setCookie("playlistAlbum", {id_low, id_high, name});
        
        $("#tablePlaylistAlbum tr").remove();
        
        itunes.albumTracks({"id_low":id_low, "id_high":id_high}, 3);
        
        $('#tdPlaylistsTitle').html(name).css('font-size', 40);
        $('#divPlaylistAlbum').scrollTop(0);
        $('#divPlaylistAlbum').animate({"left":"0"});
        $('#divPlaylist').animate({"left":"-100vw"});
      }
      
      // initial load of last selected album in playlist
      if($(window).width() < $(window).height()) {
        var playlistAlbumCfg = getCookie("playlistAlbum");
        if(playlistAlbumCfg) {
          onPlaylistAlbum(playlistAlbumCfg.id_low, playlistAlbumCfg.id_high, playlistAlbumCfg.name);
        }
      }

      function onCurrentAlbum() {
        if(track.albumArtist != '')  artist = track.albumArtist;
        else                         artist = track.artist;

        resetMainMenu();
        $('#imgMainArtists').attr('src', 'img/interpret_active.png');
        $('#tabArtists').css('display', '');
        
        $('#divArtistAlbums').css("left", "0");
        $('#divArtists').css("left", "-100vw");
  
        artistAlbum = null;
        $('#divArtistAlbum').css("left", "100vw");
        
        onArtist(track.id_low, track.id_high, artist);      
        
        $('#divAlbum').animate({"top":"100vh"});
        $('#divPlayer').css("top","0").css("left", "100vw");

        playerActive = false;
        
        $('#inputSearchArtists').val(artist);
        onKeySearchArtist();        
      }  

      function setCookie(name, value) {
        if(typeof value == 'object') {
          value = JSON.stringify(value);
        }

        document.cookie = name + '=' + value;
      }

      function removeCookie(name) {
        document.cookie = name + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC";
      }

      function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');

        for(var i = 0; i < ca.length; i++) {

          var c = ca[i];
          while (c.charAt(0) == ' ') {
            c = c.substring(1);
          }

          if (c.indexOf(name) == 0) {

            var value = c.substring(name.length, c.length);

            if(value[0] == '{') {
              return JSON.parse(value);
            }
            
            return value;
          }
        }
        return null;
      }

    </script>
              
  </body>
</html>
